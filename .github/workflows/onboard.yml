name: Onboard Client (D1 Setup)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  setup-d1:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Wrangler
        run: npm install -g wrangler@4.61.1

      # ----------------------------------------
      # Resolve DB name from wrangler.json
      # ----------------------------------------
      - name: Read DB name from wrangler.json
        id: cfg
        run: |
          set -euo pipefail
          DB_NAME="$(node -e "const c=require('./wrangler.json'); const d=c.d1_databases?.find(x=>x.binding==='DB'); if(!d) process.exit(1); process.stdout.write(d.database_name)")"
          echo "db_name=$DB_NAME" >> "$GITHUB_OUTPUT"
          echo "Using DB name: $DB_NAME"

      # ----------------------------------------
      # Create or resolve D1 database
      # ----------------------------------------
      - name: Ensure D1 database exists and capture UUID
        id: d1
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          DB_NAME: ${{ steps.cfg.outputs.db_name }}
        run: |
          set -euo pipefail

          if wrangler d1 list --json | node -e "const a=JSON.parse(require('fs').readFileSync(0)); process.exit(a.some(d=>d.name==='${DB_NAME}')?0:1)"; then
            echo "D1 exists: $DB_NAME"
          else
            echo "Creating D1: $DB_NAME"
            wrangler d1 create "$DB_NAME"
          fi

          DB_ID="$(wrangler d1 list --json | node -e "const a=JSON.parse(require('fs').readFileSync(0)); const d=a.find(x=>x.name==='${DB_NAME}'); if(!d)process.exit(2); process.stdout.write(d.uuid||d.id)")"

          if [ -z "$DB_ID" ]; then
            echo "Failed to resolve DB UUID"
            exit 3
          fi

          echo "db_id=$DB_ID" >> "$GITHUB_OUTPUT"
          echo "Resolved DB UUID: $DB_ID"

      # ----------------------------------------
      # Write database_id into wrangler.json (idempotent)
      # ----------------------------------------
      - name: Write database_id into wrangler.json
        id: write
        env:
          DB_ID: ${{ steps.d1.outputs.db_id }}
        run: |
          set -euo pipefail
          node <<'NODE'
          const fs = require('fs');

          const path = 'wrangler.json';
          const cfg = JSON.parse(fs.readFileSync(path,'utf8'));

          const db = cfg.d1_databases.find(d => d.binding === 'DB');
          if (!db) throw new Error('No DB binding found');

          const before = db.database_id || '';
          db.database_id = process.env.DB_ID;

          fs.writeFileSync(path, JSON.stringify(cfg, null, 2) + "\n");

          const changed = before !== db.database_id;
          fs.writeFileSync(process.env.GITHUB_OUTPUT, `changed=${changed}\n`, { flag: 'a' });

          console.log("DB ID before:", before || "(empty)");
          console.log("DB ID after :", db.database_id);
          NODE

          echo "----- wrangler.json -----"
          cat wrangler.json

      # ----------------------------------------
      # Apply migrations
      # ----------------------------------------
      - name: Apply D1 migrations
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: wrangler d1 migrations apply DB --remote --config ./wrangler.json

      # ----------------------------------------
      # Commit only if changed
      # ----------------------------------------
      - name: Commit wrangler.json back to repo
        if: steps.write.outputs.changed == 'true'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wrangler.json
          git commit -m "Onboard: bind D1 database_id"
          git push